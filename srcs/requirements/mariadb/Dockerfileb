FROM alpine:3.17

ARG	DB_NAME \
	DB_USER \
	DB_PASS

# Installing the needed packages mariadb and mariadb-client
RUN apk update && apk add --no-cache mariadb mariadb-client

# Step 1: "mkdir -p /run/mysqld;" Creating a /run/mysqld folder for temporary mariadb files. 
# !!! IMPORTANT !!! Some people use the directory /var/run for this prupose, but /run/ directory is a better option. The Filesystem Hierarchy Standard (FHS) recommends using /run/ as the location for runtime data, while older standards suggest /var/run/. Most modern linux systems like Alpine uses FHS recommendations but they create a symlink allowing applications to use /var/run/ directory.

# Step 2: "chmod 777 /run/mysqld;" Giving /run/mysqld all the permissions of reading, writing and executing.

# Step 3: "{ ... }" Echoing all the information needed for a mariadb configuration file and passing the info to the pipe "|".

# Step 4: "tee /etc/my.cnf.d/docker.cnf" Writing all the received echos by the pipe "|" on the /etc/my.cnf.d/docker.cnf.

# Step 5: "sed -i "s|skip-networking|skip-networking=0|g /etc/my.cnf.d/mariadb-server.cnf" Editing the /etc/my.cnf.d/mariadb-server.cnf using the sed command, with the -i option we tell sed that we want to modify the file directly. With the "s|...|g" we tell sed that we want to substitue ("s") all the ocurrences ("g") of skip-networking to skip-networking=0.
RUN mkdir -p /run/mysqld && \
	chmod 777 /run/mysqld; \
	{ \
		echo '[mysqld]'; \
		echo 'skip-host-cache'; \
		echo 'skip-name-resolve'; \
		echo 'bind-address=0.0.0.0'; \
	} | tee /etc/my.cnf.d/docker.cnf && \
	sed -i \
        	's|\[client-server\]|\[client-server\]\nport=3306\nsocket=/run/mysqld/mysqld.sock|g' \
        /etc/my.cnf \
\
 &&     sed -i \
        's|\[mysqld\]|\[mysqld\]\nuser=mysql\ndatadir=/var/lib/mysql|g' \
        /etc/my.cnf \
\
 &&     sed -i "s|.*bind-address\s*=.*|bind-address=0.0.0.0|g" \
        /etc/my.cnf.d/mariadb-server.cnf \
\
 &&     sed -i "s|.*skip-networking.*|#skip-networking|g" \
        /etc/my.cnf.d/mariadb-server.cnf

# mysqld_install_db is a command-line utility provided by mysql/mariadb for initializing the mysql data directory, specifing the user that should have all the permisions os this directory and specifing the directory where this folder should be created.
RUN mysql_install_db --user=mysql --datadir=/var/lib/mysql

# Opening the 3306 port.
EXPOSE 3306

# Copying the mariadb script into root.
COPY	requirements/mariadb/tools/db-script.sh .

# Executing the maria db script.
RUN sh db-script.sh && rm db-script.sh

# Setting the user context under which the following commands will be executed.
USER mysql

# When the container starts it will run "/usr/bin/mysqld --skip-log-error". /usr/bin/mysql runs the mysql server with the option "--skip-log-error" that tells mysql to continue running even if some errors appear.
CMD ["/usr/bin/mysqld", "--skip-log-error"]
